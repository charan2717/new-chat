{% extends "base.html" %}
{% block body %}
<div class="chat-container">
    <div class="chat-header">
        Chat Room: {{ room }}
        <a href="{{ url_for('index') }}" class="logout">Back</a>
    </div>
    <div id="messages" class="chat-messages">
        {% for msg in messages %}
        <div class="message {% if msg.sender == username %}mine{% endif %}">
            <b>{{ msg.sender }}:</b> {{ msg.text }}
        </div>
        {% endfor %}
    </div>
    <div class="chat-input">
        <input type="text" id="msgInput" placeholder="Type a message..." autocomplete="off">
        <button id="sendBtn">Send</button>
    </div>
</div>
<script>
const socket = io();
const username = "{{ username }}";
const room = "{{ room }}";

// Join app for active user tracking
socket.emit("join_app", { username });
socket.emit("join", { username, room });

const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const messagesDiv = document.getElementById("messages");

sendBtn.onclick = () => {
    const text = msgInput.value.trim();
    if (!text) return;
    socket.emit("send_message", { room, sender: username, text });
    msgInput.value = "";
};

// Real-time new message listener
socket.on("new_message", data => {
    const div = document.createElement("div");
    div.classList.add("message");
    if (data.sender === username) div.classList.add("mine");
    div.innerHTML = `<b>${data.sender}:</b> ${data.text}`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

// System messages (join/leave)
socket.on("system_message", data => {
    const div = document.createElement("div");
    div.classList.add("system-msg");
    div.textContent = data.msg;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
});
</script>

{% endblock %}

